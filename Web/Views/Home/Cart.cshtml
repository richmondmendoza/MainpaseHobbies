
@using Repository.Extensions;

@model IEnumerable<Dto.Dto.CartDetailsDto>

@{
    ViewBag.Title = "Cart";
    var user = Web.Controllers.BaseController.Identity ?? new Dto.User.AuthenticatedUserDto();

    var currency = Model.FirstOrDefault()?.Currency ?? "USD";
}

<style>
    .badge {
        width: 80px;
    }
</style>

<div class="page-title" data-aos="fade">
    <nav class="breadcrumbs">
        <div class="container">
            <ol>
                <li><a href="@Url.Action("Index", "Home", new { area ="" })">Home</a></li>
                <li class="current">Shopping Cart</li>
            </ol>
        </div>
    </nav>
</div>

<section class="service-details section">

    @*<div class="container section-title aos-init aos-animate mb-0 pb-0" data-aos="fade-up">
            <h2 class="text-left mb-2">Shopping Cart</h2>
        </div>*@

    <div class="container">

        <div class="row">
            @if (Model.Any())
            {
                <div class="col-lg-8">
                    <div class="services-list" style="border-radius: 10px;">
                        <table class="w-100" style="border-collapse: separate; border-spacing: 0 10px;">
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr style="background-color: rgba(1, 1, 1, 0.05);">
                                        <td class="p-3 td-img" style="width: 350px; max-width: 10rem; vertical-align: top; border-top-left-radius: 10px; border-bottom-left-radius: 10px;">
                                            <div class="tcg-image-container">
                                                <img id="tcg-image-preview" src="data:image/png;base64,@item.ImageBase64" class="img-fluid" alt="">
                                                @if (item.FoilType.ToLower().Replace(" ", "") == "foil" ||
                                                     item.FoilType.ToLower().Replace(" ", "") == "etchedfoil")
                                                {
                                                    <div class="tcg-foil"></div>
                                                }
                                            </div>
                                        </td>
                                        <td class="p-3" style="vertical-align: top; border-top-right-radius: 10px; border-bottom-right-radius: 10px;">
                                            <h5>@item.ProductName</h5>
                                            <p class="text-xs">
                                                @item.FoilType.ToUpper() <br />
                                                @item.Condition.ToUpper() <br />
                                                Stock: @item.Stock.ToString("n0")
                                            </p>

                                            <div class="input-group mb-4" style="width: 350px; max-width: 10rem;">
                                                <button type="button" class="input-group-text btn-primary btn-minus" link-id="@item.EncId" index="@item.Id"><i class="fa fa-minus"></i></button>
                                                <input value="@item.Quantity" limit="@item.Stock" class="form-control bg-white text-center" id="quantity-@item.Id" disabled>
                                                <button type="button" class="input-group-text btn-primary btn-plus" link-id="@item.EncId" index="@item.Id"><i class="fa fa-plus"></i></button>
                                            </div>
                                            <div class="text-left">
                                                <strong>@item.Currency @item.Price.ToString("n2")</strong>
                                                <a href="#" class="text-red m-0 p-0 border-0 d-inline float-right delete-item" link-id="@item.EncId" index="@item.Id"><i class="fa fa-trash"></i></a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="col-lg-4">

                    <div class="services-list" style="border-radius: 10px;">
                        <div class="row">
                            <h4 class="col-12 text-center mb-3">Cart Summary</h4>
                            <p class="col-12">Items <span class="float-right">@Model.Sum(a => a.Quantity).ToString("n0")</span></p>
                            <p class="col-12">Items Total <span class="float-right">@currency @Model.Sum(a => (a.Price * a.Quantity)).ToString("n2")</span></p>

                            @*<p class="col-12">Estimated Shipping <span class="float-right">@currency 0.00</span></p>*@
                            <h4 class="col-12 mb-0">Subtotal <span class="float-right">@currency @((Model.Sum(a => (a.Price * a.Quantity))).ToString("n2"))</span></h4>
                            <p class="small mb-4 text-muted pl-2" style="font-style: italic;">Taxes calculated at checkout</p>

                            <div>
                                <a href="@Url.Action("Index", "CheckOut", new {area = ""})" class="btn btn-primary mb-3 btn-block border-0 text-white" style="padding: 0.375rem 0.75rem; line-height: 1.5; margin-bottom: 1rem !important ">Check Out</a>
                                @*<button class="btn btn-warning mb-3 btn-block">Card Payment</button>*@
                            </div>
                        </div>
                    </div>

                </div>
            }
            else
            {
                <div class="col-12 text-center pt-0">
                    <img src="~/Content/website_img/empty-cart.png" class="img-fluid" style=" max-width: 200px; vertical-align: middle;" />
                    <h3>Your shopping cart is empty.</h3>
                </div>

                if (user.Id <= 0)
                {
                    <div class="col-12 text-center mt-3 mb-3">Sign in your account to view items from previous visit.</div>
                    <div class="col-12 text-center">
                        <button class="btn btn-outline-primary mr-3 pr-3 pl-3">Sign Up</button>
                        <button class="btn btn-primary pr-4 pl-4">Sign In</button>
                    </div>
                }
            }
        </div>

    </div>

</section>

@section scripts{
    <script>

        function UpdateQuantity(id, quantity) {
            $.ajax({
                url: '@Url.Action("UpdateCartItem")',
                type: 'POST',
                data: {
                    id: id,
                    quantity: quantity
                },
                success: function () {
                    location.reload();
                }
            });
        }


        $(document).ready(function () {

            $('.delete-item').on('click', function (e) {
                var id = $(this).attr('link-id');

                DeleteCartItem({
                    id: id,
                    header: 'Remove item from cart?',
                    message: 'Do you want to remove this item in your cart?'
                });
            });

            $(document).on('click', '.btn-plus', function (e) {
                ShowLoading();
                var id = $(this).attr('link-id');
                var element = $('#quantity-' + $(this).attr('index'));
                var quantity = parseInt(element.val());
                var limit = parseInt(element.attr('limit'));

                if (quantity < limit) {
                    quantity = quantity + parseInt(1);
                } else {
                    $('#message-modal').modalMessage({ message: 'You have reached the maximum number of cart item.' });
                    HideLoading();
                    return;
                }
                element.val(quantity);
                UpdateQuantity(id, quantity);
            });

            $(document).on('click', '.btn-minus', function (e) {
                ShowLoading();
                var id = $(this).attr('link-id');
                var element = $('#quantity-' + $(this).attr('index'));
                var quantity = parseInt(element.val());

                if (quantity > parseInt(1)) {
                    quantity = quantity - parseInt(1);
                } else {
                    $('#message-modal').modalMessage({ message: 'You have reached the minimum number of cart item.' });
                    HideLoading();
                    return;
                }
                element.val(quantity);
                UpdateQuantity(id, quantity);
            });

        });

    </script>

}